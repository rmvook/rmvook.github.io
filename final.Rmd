---
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile), 'final.html')) })
---
#Richard Vook CMSC320 Final

I started out this project with the idea that I wanted to be able to show the statics related to firearms in as an objective way as possible while giving the viewer the ability to dictate the political bias that they wish to see. I saw this as a very relevant issue because depending on the political preference of a writer, the data they chose to display can vary from person to person. I soon found this task to be much more difficult than previously anticipated. Through my research, I thought I would be able to show clear-cut American right vs. left political arguments for and against firearms use and ownership. 

This started to distort things more as there are many areas of common ground and there are variations to the ideas of "sensible" gun control based on the geographic region that is being discussed. The first major roadblock that I hit was the 1986 Firearms Owners Protection Act. This law has a clause that states "No such rule or regulation prescribed [by the Attorney General] after the date of the enactment of the Firearms Owners Protection Act may require that records required to be maintained under this chapter or any portion of the contents of such records, be recorded at or transferred to a facility owned, managed, or controlled by the United States or any State or any political subdivision thereof, nor that any system of registration of firearms, firearms owners, or firearms transactions or disposition be established. Nothing in this section expands or restricts the Secretary's authority to inquire into the disposition of any firearm in the course of a criminal investigation."Essentially there is no federally registered database of firearms as it is prohibited by federal law. One note about this law, it also bans the creation of new machineguns by civilians, so its repeal would result in a bit of a double-edged sword.  

Firearms use has been a hot topic recently, and there has been a lot of heated debate on the policies that can be put in place to prevent tragedies while still balancing the essential liberties of law-abiding citizens. The most recent mass shootings at Stoneman Douglas High School shooting on February 18th, 2018 and the 2017 Las Vegas shooting on October 1, 2017, have brought out many people calling for the banning of "high capacity magazines" and the banning of "bump stocks" or "rapid fire triggers." There are counters to these that schools should have armed gaurds or allow teachers to carry firearms in school. From all of this, the discussion can get heated which is why I wanted to come up with an objective as possible data science experiement to show both sides of the debate.

As I started to gather data sets, I decided to focus my project on the exploratory data analysis of what data I could find.

As I was doing this project, I found an article written that emphasizes the importance of data vizualization on this topic: https://www.nbcnews.com/news/us-news/new-jersey-releases-its-gun-data-advocates-call-it-trailblazing-n873741


The most "accurate" data that I could find on the number of people that own firearms in the US came from the following two sources. http://www.pewsocialtrends.org/2017/06/22/the-demographics-of-gun-ownership/
and https://www.factcheck.org/2013/02/did-the-1994-assault-weapons-ban-work/
Since both of these are reports and do not include the data sets themelves, I did not use this as part of my project.

Enough background, now into the tutorial.

The first step in any data science project is to gather data. As stated before, there is no federally kept database of firearms transferred. There are however generalized datasets when it comes to background checks, NFA firearms, and firearms traced in crimes. 

#Sources:

My datasets have come from the following sources

https://www.fbi.gov/file-repository/nics_firearm_checks_-_month_year.pdf/view
https://en.wikipedia.org/wiki/Estimated_number_of_guns_per_capita_by_country
https://www.atf.gov/docs/undefined/typesbystatecy2016xlsx/download
https://www.atf.gov/resource-center/firearms-trace-data-2016
Two PDF's from the ATF are included as well


Some readers may be unfamiliar with some of the terms that will be used throughout this document. I have included some to help clarify these items, definitions came from  atf.gov.

#Defenitions:

NICS: National Instant Criminal Background Check System, a system where Federally Licenesed dealers can perform nearly instantaneous background checks on purchasers, it is run through the FBI.

NFA: National Firearms AcT, refers to weapons that are controlled by this law that was passed in 1934. These firearms include 

SBS: Short Barrel Shotgun; a shotgun having a barrel or barrels of less than 18 inches in length; a weapon made from a shotgun if such weapon as modified has an overall length of less than 26 inches or a barrel or barrels of less than 18 inches in length;

SBR: Short Barrel Rifle: a rifle having a barrel or barrels of less than 16 inches in length; a weapon made from a rifle if such weapon as modified has an overall length of less than 26 inches or a barrel or barrels of less than 16 inches in length;

AOW: any other weapon; weapons or devices capable of being concealed on the person from which a shot can be discharged through the energy of an explosive. Many "any other weapons" are disguised devices such as penguns, cigarette lighter guns, knife guns, cane guns and umbrella guns.

MG: machinegun; weapons that shoot, are designed to shoot, or can be readily restored to shoot, automatically more than one shot without manual reloading by a single function of the trigger.

Silencer: A firearm silencer and a firearm muffler are defined as any device for silencing, muffling, or diminishing the report of a portable firearm.18 Firearm silencers are generally composed of an outer tube, internal baffles, a front end cap, and a rear end cap.

DD: destructive device; The first portion of the definition deals with explosive, incendiary and poison gas munitions. The definition specifies that any explosive, incendiary or poison gas bomb, grenade, mine or similar device is a destructive device. The second section of the definition states that any type of weapon by whatever name known which will, or which may be readily converted to, expel a projectile by the action of an explosive or other propellant, the barrel or barrels of which have a bore diameter of more than one-half inch in diameter is a destructive device.
```{r setup, echo = FALSE}
options(warn=-1)
library(magrittr)
library(dplyr)
require(sqldf)
library("ggthemes")
library("scales")
library(broom)
library(tidyverse)
library(lubridate)
library(randomForest)
library(ISLR)
library(cvTools)
library(tree)
library(reshape2)
library(DT)
library(fiftystater)
library(ggplot2)
library(rworldmap)
library(colorplaner)
data("fifty_states")

```
#Data Curation
The first step in any data science experiement is data curation. This is the process of collecting the data. Due to the nature of the data I was using, for several methods, I pulled in the data, one column at a time by hand. This is not the ideal way to do it, however I was not able to scrape it from the PDF directely. For the following datasets I built my dataframes by hand.
```{r Curation_International_Data}
#this data was collected from https://en.wikipedia.org/wiki/Estimated_number_of_guns_per_capita_by_country
rank <- c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,21,48,
  49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,
  94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,
  129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162
  ,163,164,165,166,167,168,169,170,171,172,173,174,175)
country <- c("UnitedStates","Serbia","Yemen","Cyprus","SaudiArabia","Iraq","Uruguay","Norway","France","Canada","Austria","Iceland","Germany",
 "Finland","Oman","Bahrain","Kuwait","Switzerland","RepublicofMacedonia","Montenegro","NewZealand","Greece","UnitedArabEmirates",
 "Croatia","Panama","Sweden","Lebanon","EquatorialGuinea","Qatar","Latvia","Peru","Angola","BosniaandHerzegovina","Belgium","Paraguay"
 ,"CzechRepublic","Thailand","Libya","Luxembourg","Mexico","Mauritius","Guyana","Gabon","Slovenia","Suriname","Guatemala","Australia"
 ,"SouthAfrica","Namibia","Armenia","Turkey","Denmark","Italy","Malta","Pakistan","Jordan","Chile","Venezuela","Spain","Argentina","Belize","CostaRica","Estonia","Somalia","Transnistria","Russia","Zambia","Albania","Portugal","Slovakia","Jamaica","Brazil","Barbados","Nicaragua"
 ,"Algeria","Belarus","Georgia","Iran","Israel","Moldova","Ukraine","UnitedKingdom","Maldives","Kenya","Swaziland","Bulgaria",
 "Honduras","Colombia","ElSalvador","Hungary","Sudan","CapeVerde","Seychelles","Bahamas","DominicanRepublic","Mozambique","Morocco",
 "Botswana","China","Cuba","Philippines","Afghanistan","RepublicofChina(Taiwan)","Zimbabwe","Cambodia","Ireland","India","Myanmar",
 "Netherlands","Syria","Turkmenistan","Azerbaijan","Egypt","Bhutan","Palestine","Bolivia","Cameroon","Djibouti","Congo","Lesotho",
 "Côted'Ivoire","Senegal","Mongolia","Comoros","Vietnam","Guinea-Bissau","Liberia","Mauritania","TrinidadandTobago","Malaysia",
 "Nigeria","SriLanka","Uzbekistan","Benin","Brunei","DemocraticRepublicoftheCongo","Tanzania","Uganda","Ecuador","Kazakhstan",
 "Poland","Burundi","Laos","Guinea","PapuaNewGuinea","BurkinaFaso","Chad","SouthKorea","Mali","CentralAfricanRepublic","Tajikistan",
 "Togo","Kyrgyzstan","Gambia","Madagascar","Nepal","Lithuania","Malawi","Niger","Romania","Haiti","Japan","NorthKorea","Rwanda",
 "SierraLeone","Bangladesh","Eritrea","Fiji","Indonesia","Singapore","Ethiopia","Ghana","SolomonIslands","Timor-Leste","Tunisia")
percapita <- c(101,58.21,54.8,36.4,35,34.2,31.8,31.3,31.2,30.8,30.4,30.3,30.3,27.3,25.5,24.8,24.8,24.45,24.1,23.1,22.6,22.5,22.1,21.7,21.7,21,21,
   19.9,19.2,19,18.8,17.3,17.3,17.2,17,16.3,15.6,15.5,15.3,15,14.7,14.6,14,13.5,13.4,13.1,24.1,12.7,12.6,12.5,12.5,12,11.9,11.9,11.6,
   11.5,10.7,10.7,10.4,10.2,10,9.9,9.2,9.1,9.1,8.9,8.9,8.6,8.5,8.3,8.1,8,7.8,7.7,7.6,7.3,7.3,7.3,7.3,7.1,6.6,6.2,6.5,6.4,6.4,6.2,6.2,
   5.9,5.8,5.5,5.5,5.4,5.4,5.3,5.1,5.1,5,4.9,4.9,4.8,4.7,4.6,4.6,4.6,4.3,4.3,4.2,4,3.9,3.9,3.8,3.5,3.5,3.5,3.4,2.8,2.8,2.8,2.7,2.7,2.4
   ,2,1.9,1.8,1.7,1.6,1.6,1.6,1.6,1.5,1.5,1.5,1.5,1.4,1.4,1.4,1.4,1.4,1.3,1.3,1.3,1.2,1.2,1.2,1.2,1.1,1.1,1.1,1.1,1,1,1,0.9,0.8,0.8,
   0.8,0.7,0.7,0.7,0.7,0.6,0.6,0.6,0.6,0.6,0.5,0.5,0.5,0.5,0.5,0.4,0.4,0.4,0.3,0.1)
international_per_captia <- data.frame(rank, country, percapita)
```
```{r curation_manufacturer_data}
#this data show the number and types of firearmsmanufactured within the united states
years <- c(1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015)
pistols <- c(662973,964561,1101011,1404753,1371427,1378252,1669537,2093362,2004298,1195284,987528,1036077,960365,995446,962901,626836,741514,811660,728511,803425,1021260,1219664,1609381,1868258,2258450,2598133,3487883,4441726,3633454,3557199)
revolvers <- c(761414,722512,754744,628573,470495,456966,469413,562292,586450,527664,498944,370428,324390,335784,318960,320143,347070,309364,294099,274205,385069,391334,431753,547195,558927,572857,667357,725282,744047,885259)
rifles <- c(970507,1007661,1144707,1407400,1211664,883482,1001833,1173694,1316607,1411120,1424315,1251341,1535690,1569685,1583042,1284554,1515286,1430324,1325138,1431372,1496505,1610923,1734536,2248851,1830556,2318088,3168206,3979570,3379549,3691799)
shotguns<- c(641482,857949,928070,935541,848948,828426,1018204,1144940,1254926,1173645,925732,915978,868639,1106995,898442,679813,741325,726078,731769,709313,714618,645231,630710,752699,743378,862401,949010,1203072,935411,777273)
misc_firearms <- c(4558,6980,35345,42126,57434,15980,16849,81349,10936,8629,17920,19680,24506,39837,30196,21309,21700,30978,19508,23179,35872,55461,92564,138815,67929,190407,306154,495142,358165,447131)
total_per_year <- c(3040934,3559663,3963877,4418393,3959968,3563106,4175836,5055637,5173217,4316342,3854439,3593504,3713590,4047747,3793541,2932655,3366895,3308404,3099025,3241494,3653324,3922613,4498944,5555818,5459240,6541886,8578610,10844792,9050626,9358661)
firearms_manufactured<-data.frame(years, pistols, revolvers, rifles, shotguns, misc_firearms)
firearms_manufactured_totals <-data.frame(years, total_per_year)
```
```{r curation_nfa_ownership_state}
#Here we can see NFA firearm ownership in the United states.
state <- c("Alabama","Alaska","Arkansas","Arizona","California","Colorado","Connecticut","District_of_Columbia","Delaware","Florida","Georgia",
   "Hawaii","Iowa","Idaho","Illinois","Indiana","Kansas","Kentucky","Louisiana","Massachusetts","Maryland","Maine","Michigan","Minnesota"
   ,"Missouri","Mississippi","Montana","North_Carolina","North_Dakota","Nebraska","New_Hampshire","New_Jersey","New_Mexico","Nevada",
   "New_York","Ohio","Oklahoma","Oregon","Pennsylvania","Rhode_Island","South_Carolina","South_Dakota","Tennessee","Texas","Utah",
   "Virginia","Vermont","Washington","Wisconsin","West_Virginia","Wyoming","Other_US_Territories")
any_other_weapons<-c(1203,327,620,1277,3932,997,911,69,32,3560,1992,34,876,640,981,1655,708,1119,662,826,1029,583,1172,2651,1401,436,450,948,203,
 761,450,429,310,860,1633,2248,1191,1571,2177,41,772,361,1648,7182,474,2917,225,1926,770,461,312,6)
Dangerous_destructive_devices<-c(78434,4722,49499,105067,272128,47275,12747,39733,3032,181734,72360,7128,16013,17733,103789,43209,23056,31652,
 53320,16125,51750,3480,25626,47026,32259,10219,3873,88957,2712,6676,4647,43518,80595,36691,43841,82747,16894,
 22461,151611,3234,35829,3959,43024,250568,16782,201831,2617,46224,31704,18343,120927,323)
Machine_guns <-c(26307,1650,5319,16874,29047,7206,52965,5086,585,36194,29525,413,3508,4135,33646,19190,3679,14774,6803,6682,25134,5378,15142,
 8262,9588,4392,2368,12629,1586,2226,22468,8006,3887,11752,12687,21561,9347,6487,18752,636,8877,1874,14144,36534,6884,34074,
 1202,4345,7443,6761,1790,215)
Supressors <-c(48118,6040,19979,40485,15044,28378,10819,389,326,85998,63021,163,6490,23475,3672,34630,20948,27733,48903,9565,16183,3371,18381,
   16272,21271,16745,13471,37283,7512,9790,31144,1331,9241,18563,4134,52495,37055,24072,39924,33,50647,13949,27040,242859,42406,44012
   ,1246,31180,19010,6915,8294,18)
short_barrel_rifles <- c(5285,1783,3266,13695,10796,6804,3951,848,233,27092,11755,59,604,3100,2678,6361,3195,3927,5385,2977,5078,2084,4042,3972,
 5839,2833,1505,9297,974,1944,4895,1664,2815,7476,6321,8352,5005,5283,10779,170,5456,787,7274,43354,4930,16599,433,7173,
 4684,1715,1087,12)
short_barrel_shotguns <- c(2294,1302,1158,2340,13675,1775,1007,1103,644,8710,11397,62,1003,483,1721,8974,1048,1863,1758,977,3935,475,1379,1124,
   2638,869,466,3124,285,837,531,2559,732,1546,7591,6002,1777,1509,13134,109,4020,200,6029,8199,1380,8389,149,987,1267,
   1069,396,97)
totals_per_state <-c(161641,15824,79841,179738,344622,92435,82400,47228,4852,343288,190050,7859,28494,49566,146487,114019,52634,81068,116831,
 37152,103109,15371,65742,79307,72996,35494,22133,152238,13272,22234,64135,57507,97580,76888,76207,173405,71269,61383,236377
 ,4223,105601,21130,99159,588696,72856,307822,5872,91835,64878,35264,132806,671)
nfa_items_by_state<-data.frame(state, any_other_weapons, Dangerous_destructive_devices, Machine_guns, Supressors, short_barrel_rifles,
   short_barrel_shotguns)
```
The remaining datasets that I used are imported from excel. In these cases I created the excel tables myself from data found in the pdfs.
```{r curation_trace_data_2016}
#This is dataset is the firarms traces done by the Bureau of Alcohol, tobacco and firearms. It includes all data from 01/01/2016 to 12/31/2018. When a firarms trace happens, a police department finds a firearm at the scene of a crime. They then call up the ATF to trace it. The process by law cannot happen from an electronic database, so as the firearm is recovered
library(readxl)
trace_type_by_state_2016 <- read_excel("trace_type_by_state_2016.xlsx")
```
```{r curation_nics}
#The best metric that the US government records for the number of firearms sold to civilians is the number of NICS checks performed. NICS stands for National Instant Criminal Background Check System. When a person purchases a firearm through a Federal Firearm License holder, this is any store in the united states that can conduct firearms sales legally, the dealer calls into the NICS system to perform a background check before they can sell the person a firearm.
#As transposed from the PDF, this is what the initial dataset looked like.
nics <- read_excel("nics_checks.xlsx")
#I ended up making my own excel sheet of tidy data to better represent this.
nics_tidy <- read_excel("nics_checks_tidy.xlsx")
```
#Data cleaning
The next step after curation is to parse the data and to check that everything is as it should be. In this section I will also be added other variables that will be usefule to analysis later.
```{r data_cleaning_verification}
datatable(international_per_captia,filter="top",style="bootstrap")

datatable(firearms_manufactured_totals,filter="top",style="bootstrap")
datatable(firearms_manufactured,filter="top",style="bootstrap")

datatable(nfa_items_by_state,filter="top",style="bootstrap")

trace_type_by_state_2016$TOTAL <- NULL
datatable(trace_type_by_state_2016,filter="top",style="bootstrap")

#here I convert the month into a date format
nics_tidy$date <- as.Date(nics_tidy$Month, format= "%Y-%m-%d")
nics_tidy$Month <- NULL

#from here I wanted to separate each year out to see what more I could find out. I created a year column
nics_tidy$year <- year(nics_tidy$date)
nics_tidy$month <- month(nics_tidy$date)

datatable(nics,filter="top",style="bootstrap")
datatable(nics_tidy,filter="top",style="bootstrap")

```
#Exploratory Data Analysis
Here we begin to get into the exploratory data analysis. This tutorial will heavily emphasize the vizualzation of these different data sets. You will see several different represenations of data and ways to view it.

```{r explore_international}
#Here I create a bargrarph of all th firearms per capita.
international_per_captia %>%
  ggplot(aes(x = rank, y = percapita))  +
  geom_bar(stat = "identity") + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")+
  labs(title="International Firearms Ownership Per Capita",
         x = "Country Rank",
         y = "Per Capita Ownership per 100 people")
#Although it cannot be read, the number 1 ranekd country in the world is the United states as shown all of the way on the left. The ranking of Australia is also misplaced in the dataset.
```


```{r explore_types_manufactured}
#One of the simple ways to display data is to display it in a bar graph. I use the melt function to show the various types of firearms manufactured each year in the united states.
firearms_manufactured_melted <- melt(firearms_manufactured, id.var="years")

firearms_manufactured_melted %>%  
  ggplot(aes(x = years, y = value, fill = variable))  +
  geom_bar(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")

firearms_manufactured_totals %>%  
  ggplot(aes(x = years, y = total_per_year))  +
  geom_bar(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")

#from this chart you can see that overtime the number of firearms made has increased from year to year.
```


```{r nfa_items_state}
#In this section I show the breakdown of the types of NFA items that are owned within each state. This is some of the most accurate data that the federal government has. NFA items are highly regulated at the federal level and take almost a year to get. Again, I break down the types using the melt function for the bar graph and rotate it to read easily. 
nfa_items_by_state_melt <- melt(nfa_items_by_state, id.var="state")

nfa_items_by_state_melt %>%  
  ggplot(aes(x = state, y = value, fill = variable))  +
  geom_bar(stat = "identity") + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")+
  coord_flip()

nfa_items_by_state_total<-data.frame(state,totals_per_state)

nfa_items_by_state_total %>%  
  ggplot(aes(x = state, y = totals_per_state))  +
  geom_bar(stat = "identity") + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")+
  coord_flip()
```
```{r trace_data}
#Getting into another dataset, I use the same kind of bar graphs as before to show the firearms tracing data. A firearm is traced when it is found in a crime and the governemnt needs to figure out who it was sold to. I have also shown the breakdown of Maryland to bring it closer to home.
trace_type_by_state_2016_melt <- trace_type_by_state_2016 %>%
  filter(STATE != "TOTAL") %>%
  melt(id.var="STATE")

trace_type_by_state_2016_melt %>%  
  ggplot(aes(x = STATE, y = value, color = value, fill = variable))  +
  geom_bar(stat = "identity") + 
  coord_flip()
#MD data
MD_traces <- trace_type_by_state_2016 %>%
  filter(STATE == "MARYLAND")
MD_traces

MD_traces_melt <- MD_traces %>% melt(id.var="STATE")

MD_traces_melt
MD_traces_melt %>%  
  ggplot(aes(x = variable, y = value ,fill = variable))  +
  geom_bar(stat = "identity")+ 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")+
  coord_flip()
#like most states, the most common firearm usedin crimes were pistols in the state of MD
```

```{r nics_visualization}
#Here I move into showing my last datasets which include the number of background checks performed by the FBI. When a firearm is purchased, a NICS check is run. They are not necessarily a 1:1 relationship. Some NICS checks are denied and sometimes people purchase more than one firearm on the same background check. I decided to show both a bar graph and a linegraph with a liear fit line to show that the number of NICS checks has been increasing.
nics_tidy %>%
  ggplot(aes(x = date, y = value))  +
  geom_bar(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
#here is a line graph representaiton
nics_tidy %>%
  ggplot(aes(x = date, y = value))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
#One way to display graphs is to facet the data into smaller chunks. Here I break my data from 1998 to 2018 into 5 sections and display their general trends.
#from there I created a yearID to break the dataset into 5 distinct cuts.
nics_tidy$yearID <- cut(nics_tidy$year, 5)
nics_tidy
#here we can see the 5 facets being printed next to each other
nics_tidy %>%
  filter(yearID%in% c("(1998,2002]", "(2002,2006]","(2006,2010]", "(2010,2014]", "(2014,2018]")) %>%
  ggplot(aes(x = date, y = value)) +
  facet_grid(.~yearID) +
  geom_path(stat = "identity") +  
  geom_smooth(method=lm, color = 'red')+
  scale_x_date(date_breaks = "1 month", 
 labels=date_format("%b-%Y"))
#from this, we can see that in each 5 year block there is a clear increase in the number of NICS checks in each 4 year block.

```
```{r more_nics_visualizations}

nics_tidy <- nics_tidy %>%
  group_by(year) %>%
  mutate(avgyear = mean(value))

nics_tidy <- nics_tidy %>%
  group_by(month) %>%
  mutate(avgmonth = mean(value))

nics_tidy


nics_tidy %>%
  filter(year > "1998" & year < "2018") %>%
  group_by(year) %>%
  ggplot(aes(x = factor(year), y =avgyear))  +
  geom_bar(stat = "identity") + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")

nics_tidy %>%
  group_by(month) %>%
  ggplot(aes(x = month, y = avgmonth))  +
  geom_bar(stat = "identity") + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
nics_tidy %>%
  ggplot(aes(x = as.factor(year), y = value))  +
  geom_violin()+
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
nics_tidy%>%
  ggplot(aes(x=as.factor(year), y=value)) +
  geom_boxplot()

```

```{r}
#Another rpersenation, I decided to group by year to see some different trends.
nics_tidy %>%
  filter(year>"1998" & year < "2018")%>%
  ggplot(aes(x = date, y = value, group=factor(year)))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
#As you can see, there are severa years where the number of NICS checks seemed to decrease or level off. I went ahead and made a graph of each year to better show this.
```
The Next set of graphs are to display the NICS checks for each year from 1999 to 2017. They give you a good idea of the month to month trends.
```{r}
nics_tidy %>%
  filter(year == "1999") %>%
  ggplot(aes(x = date, y = value, group=factor(year)))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
nics_tidy %>%
  filter(year == "2000") %>%
  ggplot(aes(x = date, y = value, group=factor(year)))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
nics_tidy %>%
  filter(year == "2001") %>%
  ggplot(aes(x = date, y = value, group=factor(year)))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
nics_tidy %>%
  filter(year == "2002") %>%
  ggplot(aes(x = date, y = value, group=factor(year)))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
nics_tidy %>%
  filter(year == "2003") %>%
  ggplot(aes(x = date, y = value, group=factor(year)))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
nics_tidy %>%
  filter(year == "2004") %>%
  ggplot(aes(x = date, y = value, group=factor(year)))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
nics_tidy %>%
  filter(year == "2005") %>%
  ggplot(aes(x = date, y = value, group=factor(year)))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
nics_tidy %>%
  filter(year == "1999") %>%
  ggplot(aes(x = date, y = value, group=factor(year)))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
nics_tidy %>%
  filter(year == "2006") %>%
  ggplot(aes(x = date, y = value, group=factor(year)))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
nics_tidy %>%
  filter(year == "2007") %>%
  ggplot(aes(x = date, y = value, group=factor(year)))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
nics_tidy %>%
  filter(year == "2008") %>%
  ggplot(aes(x = date, y = value, group=factor(year)))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
nics_tidy %>%
  filter(year == "2009") %>%
  ggplot(aes(x = date, y = value, group=factor(year)))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
nics_tidy %>%
  filter(year == "2010") %>%
  ggplot(aes(x = date, y = value, group=factor(year)))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
nics_tidy %>%
  filter(year == "2011") %>%
  ggplot(aes(x = date, y = value, group=factor(year)))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
nics_tidy %>%
  filter(year == "2012") %>%
  ggplot(aes(x = date, y = value, group=factor(year)))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
nics_tidy %>%
  filter(year == "2013") %>%
  ggplot(aes(x = date, y = value, group=factor(year)))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
nics_tidy %>%
  filter(year == "2014") %>%
  ggplot(aes(x = date, y = value, group=factor(year)))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
nics_tidy %>%
  filter(year == "2015") %>%
  ggplot(aes(x = date, y = value, group=factor(year)))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
nics_tidy %>%
  filter(year == "2016") %>%
  ggplot(aes(x = date, y = value, group=factor(year)))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
```{r}
nics_tidy %>%
  filter(year == "2017") %>%
  ggplot(aes(x = date, y = value, group=factor(year)))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```
Continueing on with my Exploratory data analysis, I wanted to see if I could combine two of my data sets to show information about different states. I created a column in my nfa_items_by_state dataframe that counts the number of firearm traces in the year 2016. My goal with this is to potentially see which states possess more of certain firearms in crimes compared to what is legally owned by the state. Unfortunately, the trace data did not have a section for SBR's and SBS's so I used the catagory of rifles and shotguns in their place.
```{r}
nfa_items_by_state$state <- tolower(nfa_items_by_state$state)
nfa_items_by_state$state <- gsub('_', ' ', nfa_items_by_state$state)
trace_type_by_state_2016$STATE <- tolower(trace_type_by_state_2016$STATE)

nfa_items_by_state$aowtraces <- 0
nfa_items_by_state$ddtraces <- 0
nfa_items_by_state$mgtraces <- 0
nfa_items_by_state$sptraces <- 0
nfa_items_by_state$sbrtraces <- 0
nfa_items_by_state$sbstraces <- 0

for (i in seq(1, nrow(nfa_items_by_state))) {
  for (j in seq(1, nrow(trace_type_by_state_2016))) {
    if(!is.na(trace_type_by_state_2016$STATE[i]) & !is.na(nfa_items_by_state$state[j])&trace_type_by_state_2016$STATE[i] == nfa_items_by_state$state[j]){
        nfa_items_by_state$aowtraces[i] <- trace_type_by_state_2016$`ANY OTHER WEAPON`[j]
        nfa_items_by_state$ddtraces[i] <- trace_type_by_state_2016$`DESTRUCTIVE DEVICE`[j]
        nfa_items_by_state$mgtraces[i] <- trace_type_by_state_2016$MACHINEGUN[j]
        nfa_items_by_state$sptraces[i] <- trace_type_by_state_2016$SILENCER[j]
        nfa_items_by_state$sbrtraces[i] <- trace_type_by_state_2016$RIFLE[j]
        nfa_items_by_state$sbstraces[i] <- trace_type_by_state_2016$SHOTGUN[j]
    }
  }
}
datatable(nfa_items_by_state,filter="top",style="bootstrap")

p <- ggplot(nfa_items_by_state, aes(map_id = state)) + 
  geom_map(aes(fill = any_other_weapons), map = fifty_states) + 
  expand_limits(x = fifty_states$long, y = fifty_states$lat) +
  coord_map() +
  scale_x_continuous(breaks = NULL) + 
  scale_y_continuous(breaks = NULL) +
  labs(x = "", y = "") +
  theme(legend.position = "bottom", panel.background = element_blank())+
  aes(fill2 = aowtraces) + scale_fill_colorplane() +
  theme(legend.position = "right")
p + fifty_states_inset_boxes() 
```
```{r}
nfa_items_by_state$state <- tolower(nfa_items_by_state$state)
p <- ggplot(nfa_items_by_state, aes(map_id = state)) + 
  geom_map(aes(fill = Dangerous_destructive_devices), map = fifty_states) + 
  expand_limits(x = fifty_states$long, y = fifty_states$lat) +
  coord_map() +
  scale_x_continuous(breaks = NULL) + 
  scale_y_continuous(breaks = NULL) +
  labs(x = "", y = "") +
  theme(legend.position = "bottom", 
        panel.background = element_blank())+
  aes(fill2 = ddtraces) + scale_fill_colorplane() +
  theme(legend.position = "right")
p + fifty_states_inset_boxes() 
```
```{r}
nfa_items_by_state$state <- tolower(nfa_items_by_state$state)
p <- ggplot(nfa_items_by_state, aes(map_id = state)) + 
  geom_map(aes(fill = Machine_guns), map = fifty_states) + 
  expand_limits(x = fifty_states$long, y = fifty_states$lat) +
  coord_map() +
  scale_x_continuous(breaks = NULL) + 
  scale_y_continuous(breaks = NULL) +
  labs(x = "", y = "") +
  theme(legend.position = "bottom", 
        panel.background = element_blank())+
  aes(fill2 = mgtraces) + scale_fill_colorplane() +
  theme(legend.position = "right")
p + fifty_states_inset_boxes() 
```
```{r}
nfa_items_by_state$state <- tolower(nfa_items_by_state$state)
p <- ggplot(nfa_items_by_state, aes(map_id = state)) + 
  geom_map(aes(fill = Supressors), map = fifty_states) + 
  expand_limits(x = fifty_states$long, y = fifty_states$lat) +
  coord_map() +
  scale_x_continuous(breaks = NULL) + 
  scale_y_continuous(breaks = NULL) +
  labs(x = "", y = "") +
  theme(legend.position = "bottom", 
        panel.background = element_blank())+
  aes(fill2 = sptraces) + scale_fill_colorplane() +
  theme(legend.position = "right")
p + fifty_states_inset_boxes() 
```
```{r}
nfa_items_by_state$state <- tolower(nfa_items_by_state$state)
p <- ggplot(nfa_items_by_state, aes(map_id = state)) + 
  geom_map(aes(fill = short_barrel_rifles), map = fifty_states) + 
  expand_limits(x = fifty_states$long, y = fifty_states$lat) +
  coord_map() +
  scale_x_continuous(breaks = NULL) + 
  scale_y_continuous(breaks = NULL) +
  labs(x = "", y = "") +
  theme(legend.position = "bottom", 
        panel.background = element_blank())+
  aes(fill2 = sbrtraces) + scale_fill_colorplane() +
  theme(legend.position = "right")
p + fifty_states_inset_boxes() 
```
```{r}
nfa_items_by_state$state <- tolower(nfa_items_by_state$state)
p <- ggplot(nfa_items_by_state, aes(map_id = state)) + 
  geom_map(aes(fill = short_barrel_shotguns), map = fifty_states) + 
  expand_limits(x = fifty_states$long, y = fifty_states$lat) +
  coord_map() +
  scale_x_continuous(breaks = NULL) + 
  scale_y_continuous(breaks = NULL) +
  labs(x = "", y = "") +
  theme(legend.position = "bottom", 
        panel.background = element_blank())+
  aes(fill2 = sbstraces) + scale_fill_colorplane() +
  theme(legend.position = "right")
p + fifty_states_inset_boxes() 
```
#Hypothesis Testing
Unfortunately due to the lack of data on this, hypothesis testing is rather difficult. I wanted to see if I could my data to predict future values using a random forrest with the code that I have used previously. This failed miserably, but I have included the code that I attmepted to use. 
```{r}
nics_tidy$Direction <- NA
for (i in seq(1, nrow(nics_tidy))) {
  diff <- nics_tidy$value[i+1] - nics_tidy$value[i]
  nics_tidy$Direction[i] <- ifelse(diff>0, "up", "down")
}
nics_tidy[is.na(nics_tidy)] <- "up"
datatable(nics_tidy,filter="top",style="bootstrap")

```

```{r, eval = FALSE}
set.seed(1234)
nics_tidy_test_rf <- nics_tidy %>%
  group_by(Direction) %>%
  sample_frac(.2) %>%
  ungroup()

nics_tidy_train_rf <- nics_tidy %>%
  anti_join(nics_tidy_test_rf, by="date")

rf_1998 <- randomForest(Direction~., data=nics_tidy_train_rf$value)
rf_1998

test_predictions_1998 <- predict(rf_1998, newdata=test_random_forest_df_1998$value)

table(pred=test_predictions_1998, observed=test_random_forest_df_1998$Direction)
```

```{r, eval = FALSE}
set.seed(1234)

library(caret)
# create the cross-validation partition
result_df <- createFolds(nics_tidy$Direction, k=10) %>%
  # fit models and gather results
  purrr::imap(function(test_indices, fold_number) {
    test_df <- nics_tidy %>%
      select(-date) %>%
      slice(test_indices)
  
    #using the rf's that I created above.
    rf1 <- rf_1998

    # gather results
    test_df %>%
      select(observed_label = Direction) %>%
      mutate(fold=fold_number) %>%
      mutate(prob_positive_rf1 = predict(rf1, newdata=test_df, type="prob")[,"up"]) %>%
      # add predicted labels for rf1 using a 0.5 probability cutoff
      mutate(predicted_label_rf1 = ifelse(prob_positive_rf1 > 0.5, "up", "down")) 
      
     
}) %>%
  # combine the five result data frames into one
  purrr::reduce(bind_rows)
result_df
```


Table (result of hypothesis testing difference between algorithms) and AUROC curve plot.
```{r, eval = FALSE}
result_df %>%
  mutate(error_rf1 = observed_label != predicted_label_rf1) %>%
  group_by(fold) %>%
  summarize(big_rf = mean(error_rf1), small_rf = mean(error_rf2)) %>%
  tidyr::gather(model, error, -fold) %>%
  lm(error~model, data=.) %>%
  broom::tidy()
```


#Machine learning
In my machine learning experiement I attempted to predict future values for the number of NICS checks in the future. Unfortunately this was a single variable and was just an observation. I attemped to fit it to a linear regression model which it turns out that it is not a linear regression, but a cycle that follows a linear trend. It is beyond the scope of the course to do that and was not able to show it.

```{r}
#I hypothesize that in the future, the number of NICS checks will continue to increase.

nics_sample <- nics_tidy %>% 
  sample_frac(.3) #sampleing 20% of the dataframe


model <- lm(value~date, data=nics_sample)

future <- predict(model, newdata=nics_sample)
future

final_df <- as.data.frame(t(future))
final_df

last_df <- as.data.frame(t(final_df))
last_df

last_df$ID <- seq.int(nrow(last_df))
last_df$value <- last_df[,1]
last_df

last_df %>%
  ggplot(aes(x = ID, y = value))  +
  geom_path(stat = "identity") + 
  geom_smooth(method=lm) + 
  theme_solarized(light = FALSE) +
  scale_colour_solarized("red")
```

If I had a dataset that showed every NICS check, information on the firearm(s) purchased, as well as the demographic infomration on the purchaser I could come up with a predictive model as to who is purchasing firearms and why.

Lessons Learned:
1. Data science is difficult when there are laws on the collection of the data that you are trying to collect
2. We will never really know as a society how many firearms there are in circulation. One thing missing from all of this data is the fact that it is completely legal for law abiding citizens to build their own firearms for personal use at home. On top of that, the ATF only knows of the legal firearms that are imported/exported/manufactured/transferred.
3. Firearms sales, NICS checks, form and almost cyclical pattern with more weapons being purchased in April and December. These can probably be attributed to tax refunds in April and black friday sales of firearms.
4. Anecdotally, one fact taht I found online was that there are increases in firearms purchases when there is a fear that they will be banned. This includes time periods right after mass shootings or when there are national elections with a strong Democratic Candidate running.
5. On Average, firearms sales are lowest in May, June, and July
6.Overall Firearms sales have continued to increase each year since 1998.
7. Apparently Maryland stands out as a state when it comes to destructie Devices. Maryland has very few legally registered, but has a comparatively large number of them recovered in crimes. TLDR: Marylanders disproportionately use grenade launchers and or explosives in crimes more than any of the other 49 states.
